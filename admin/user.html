<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Progress (admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 18px; }
    h1 { margin: 0 0 10px; }
    .bar { display:flex; gap:10px; align-items:center; margin: 8px 0 16px; flex-wrap: wrap; }
    input[type="number"]{ width:90px; padding:6px; }
    input[type="text"]{ width:320px; padding:6px; }
    button, a.btn{ padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; text-decoration:none; }
    table{ border-collapse: collapse; width:100%; margin-top: 10px; }
    th, td{ border:1px solid #ddd; padding:8px; vertical-align: top; }
    th{ background:#f5f7fb; position:sticky; top:0; }
    td.text{ max-width: 520px; }
    .muted{ color:#666 }
    #chartWrap { margin: 8px 0 12px; }
    .name { font-weight: 700; }
  </style>
</head>
<body>
  <h1>User Progress (admin)</h1>

  <div class="bar">
    <label>UID <input id="uid" type="text" /></label>
    <label>Limit <input id="limit" type="number" value="500" min="1" max="1000"></label>
    <button id="load">Load</button>
    <a id="csv" class="btn" target="_blank">Download CSV</a>
    <button id="renameBtn">Rename</button>
    <span id="nameBadge" class="name"></span>
    <span class="muted">Token is stored in this tabâ€™s session only.</span>
  </div>

  <div id="chartWrap"><canvas id="chart" height="120"></canvas></div>

  <table id="grid">
    <thead>
      <tr>
        <th>Time (local)</th><th>Passage</th><th>Part</th>
        <th>Acc</th><th>Flu</th><th>Comp</th><th>Pron</th>
        <th class="text">Text</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
const qs = new URLSearchParams(location.search);
let TOKEN = sessionStorage.getItem('ADMIN_TOKEN') || qs.get('token');
if (!TOKEN) {
  TOKEN = prompt('Enter ADMIN_TOKEN');
  if (!TOKEN) throw new Error('No token');
  sessionStorage.setItem('ADMIN_TOKEN', TOKEN);
}

const uidEl   = document.getElementById('uid');
const limitEl = document.getElementById('limit');
const csvEl   = document.getElementById('csv');
const nameEl  = document.getElementById('nameBadge');
uidEl.value = qs.get('uid') || '';

const ctx = document.getElementById('chart').getContext('2d');
let chart;
function esc(s=''){ return s.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

// 7-day moving average (time-windowed)
function ma7(points) {
  const ms7 = 7 * 24 * 60 * 60 * 1000;
  const out = [];
  for (let i = 0; i < points.length; i++) {
    const t0 = points[i].t.getTime() - ms7;
    let sum = 0, n = 0;
    for (let j = i; j >= 0; j--) {
      if (points[j].t.getTime() >= t0) { sum += points[j].y; n++; } else break;
    }
    out.push(n ? Number((sum / n).toFixed(1)) : null);
  }
  return out;
}

async function rename(uid, currentLabel='') {
  const label = prompt('Set name for this UID:', currentLabel || '');
  if (label == null) return;
  const r = await fetch('/api/admin-label-user', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-token': TOKEN },
    body: JSON.stringify({ uid, label })
  });
  if (!r.ok) { alert('Save failed'); return; }
  await load();
}

async function load() {
  const uid = (uidEl.value || '').trim();
  if (!uid) { alert('Enter a UID'); return; }
  const limit = Number(limitEl.value) || 500;

  csvEl.href = `/api/admin-resend?token=${encodeURIComponent(TOKEN)}&format=csv&uid=${encodeURIComponent(uid)}&limit=${limit}`;
  const url  = `/api/admin-recent?token=${encodeURIComponent(TOKEN)}&uid=${encodeURIComponent(uid)}&limit=${limit}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) { alert('Load failed'); return; }
  const { rows } = await r.json();

  // name badge (from any row with label)
  const lbl = rows.find(r => r.label)?.label || '';
  nameEl.textContent = lbl ? `(${lbl})` : '';

  // table
  const tbody = document.querySelector('#grid tbody');
  tbody.innerHTML = '';
  const pts = [];
  for (const row of rows.slice().reverse()) { // oldest -> newest for chart
    const s = row.summary || {};
    const when = new Date(row.ts);
    pts.push({ t: when, y: Number(s.pron ?? 0) });
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${when.toLocaleString()}</td>
      <td>${esc(row.passage_key)}</td>
      <td>${row.part_index}</td>
      <td>${s.acc ?? ''}</td><td>${s.flu ?? ''}</td><td>${s.comp ?? ''}</td><td>${s.pron ?? ''}</td>
      <td class="text">${esc(row.text || '')}</td>`;
    tbody.appendChild(tr);
  }

  // chart
  const labels = pts.map(p => p.t.toLocaleString());
  const raw    = pts.map(p => p.y);
  const avg7   = ma7(pts);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Pron score', data: raw, borderWidth: 2, tension: 0.25, pointRadius: 3 },
        { label: '7-day MA', data: avg7, borderWidth: 2, tension: 0.25, pointRadius: 0, borderDash: [6,4] }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { min: 0, max: 100 } }
    }
  });

  // rename button
  document.getElementById('renameBtn').onclick = () => rename(uid, lbl);
}

document.getElementById('load').addEventListener('click', load);
if (uidEl.value) load();
</script>
</body>
</html>
