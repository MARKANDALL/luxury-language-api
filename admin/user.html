<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Progress (admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 18px; }
    h1 { margin: 0 0 10px; }
    .bar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 8px 0 16px; }
    input[type="text"]{ width:420px; padding:6px; }
    input[type="number"]{ width:90px; padding:6px; }
    button, a.btn{ padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; text-decoration:none; }
    table{ border-collapse: collapse; width:100%; margin-top: 10px; }
    th, td{ border:1px solid #ddd; padding:8px; vertical-align: top; }
    th{ background:#f5f7fb; position:sticky; top:0; }
    td.text{ max-width: 520px; }
    .muted{ color:#666 }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>User Progress (admin)</h1>

  <div class="bar">
    <label>UID <input id="uid" type="text" /></label>
    <label>Limit <input id="limit" type="number" value="500" min="1" max="1000"></label>
    <button id="load">Load</button>
    <a id="csv" class="btn" target="_blank">Download CSV</a>
    <span class="muted">Token is stored in this tab’s session only.</span>
  </div>

  <div class="bar">
    <label>Display name <input id="label" type="text" placeholder="e.g., Mark H." /></label>
    <button id="saveLabel">Save name</button>
    <span id="saveMsg" class="muted"></span>
  </div>

  <div style="max-width: 1100px;">
    <canvas id="chart" height="110"></canvas>
  </div>

  <table id="grid">
    <thead>
      <tr>
        <th>Time (local)</th><th>Passage</th><th>Part</th>
        <th>Acc</th><th>Flu</th><th>Comp</th><th>Pron</th>
        <th class="text">Text</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
const qs = new URLSearchParams(location.search);
let TOKEN = sessionStorage.getItem('ADMIN_TOKEN') || qs.get('token');
if (!TOKEN) {
  TOKEN = prompt('Enter ADMIN_TOKEN');
  if (!TOKEN) throw new Error('No token');
  sessionStorage.setItem('ADMIN_TOKEN', TOKEN);
}

const uidEl   = document.getElementById('uid');
const limitEl = document.getElementById('limit');
const labelEl = document.getElementById('label');
const saveMsg = document.getElementById('saveMsg');
const csvEl   = document.getElementById('csv');
const tbody   = document.querySelector('#grid tbody');
const chartEl = document.getElementById('chart');

uidEl.value = qs.get('uid') || uidEl.value;

const esc = (s) => (s || '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));

let chart;

function movingAverage7d(rows) {
  // rows are newest-first; make ascending for window math
  const asc = [...rows].sort((a,b) => new Date(a.ts) - new Date(b.ts));
  const times = asc.map(r => new Date(r.ts).getTime());
  const values = asc.map(r => r.summary?.pron ?? null);

  const win = 7 * 24 * 3600 * 1000; // 7 days
  let start = 0, sum = 0, count = 0;
  const maAsc = asc.map((_, i) => {
    const v = values[i];
    if (typeof v === 'number') { sum += v; count += 1; }
    while (times[i] - times[start] > win) {
      const vs = values[start];
      if (typeof vs === 'number') { sum -= vs; count -= 1; }
      start++;
    }
    return count ? +(sum / count).toFixed(1) : null;
  });

  // Convert back to newest-first to match labels
  const newestFirstMA = maAsc.reverse();
  return newestFirstMA;
}

function buildChart(rows) {
  const labels = rows.map(r => new Date(r.ts).toLocaleString());
  const pron   = rows.map(r => r.summary?.pron ?? null);
  const ma7    = movingAverage7d(rows);

  if (chart) chart.destroy();
  chart = new Chart(chartEl, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Pron score',
          data: pron,
          spanGaps: true,
          pointRadius: 3,
          borderWidth: 0,
        },
        {
          label: '7-day avg',
          data: ma7,
          spanGaps: true,
          pointRadius: 0,
          borderWidth: 2,
          tension: 0.25,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        y: { min: 0, max: 100, title: { display: true, text: 'Score' } }
      }
    }
  });
}

async function load() {
  const uid = (uidEl.value || '').trim();
  if (!uid) { alert('Enter a UID'); return; }

  const limit = Number(limitEl.value) || 500;
  csvEl.href = `/api/admin-resend?token=${encodeURIComponent(TOKEN)}&format=csv&uid=${encodeURIComponent(uid)}&limit=${limit}`;

  const url = `/api/admin-recent?token=${encodeURIComponent(TOKEN)}&uid=${encodeURIComponent(uid)}&limit=${limit}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) { alert('Load failed: ' + r.status); return; }
  const { rows } = await r.json();

  // If the API attached a label, show it in the input
  const firstWithLabel = rows.find(r => r.label);
  if (firstWithLabel) labelEl.value = firstWithLabel.label;

  buildChart(rows);

  // Table
  tbody.innerHTML = '';
  for (const row of rows) {
    const s = row.summary || {};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(row.ts).toLocaleString()}</td>
      <td>${esc(row.passage_key)}</td>
      <td>${row.part_index}</td>
      <td>${s.acc ?? ''}</td>
      <td>${s.flu ?? ''}</td>
      <td>${s.comp ?? ''}</td>
      <td>${s.pron ?? ''}</td>
      <td class="text">${esc(row.text)}</td>`;
    tbody.appendChild(tr);
  }
}

async function saveLabel() {
  const uid = (uidEl.value || '').trim();
  const label = (labelEl.value || '').trim();
  if (!uid || !label) { alert('Enter UID and a display name'); return; }

  saveMsg.textContent = 'Saving…';
  const r = await fetch(`/api/admin-label-user?token=${encodeURIComponent(TOKEN)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ uid, label })
  });
  if (!r.ok) { saveMsg.textContent = 'Failed'; return; }
  saveMsg.textContent = 'Saved';
  setTimeout(() => (saveMsg.textContent = ''), 1200);
}

document.getElementById('load').addEventListener('click', load);
document.getElementById('saveLabel').addEventListener('click', saveLabel);

// Auto-load if uid came from /admin/ index link
if (uidEl.value) load();
</script>
</body>
</html>
