<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Progress (admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:18px}
    h1{margin:0 0 10px}
    .bar{display:flex;gap:10px;align-items:center;margin:8px 0 16px}
    input[type="text"]{width:460px;max-width:80vw;padding:6px}
    input[type="number"]{width:90px;padding:6px}
    button,a.btn{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;text-decoration:none;cursor:pointer}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#f5f7fb;position:sticky;top:0}
    td.text{max-width:560px}
    .muted{color:#666}
    #chartWrap{margin:8px 0 12px}
  </style>
</head>
<body>
  <h1 id="title">User Progress (admin)</h1>

  <div class="bar">
    <label>UID <input id="uid" type="text" /></label>
    <label>Limit <input id="limit" type="number" value="500" min="1" max="1000"></label>
    <button id="load">Load</button>
    <a id="csv" class="btn" target="_blank">Download CSV</a>
    <span class="muted">Token is stored in this tab’s session only.</span>
  </div>

  <div id="chartWrap">
    <canvas id="chart" height="100"></canvas>
  </div>

  <table id="grid">
    <thead>
      <tr>
        <th>Time (local)</th><th>Passage</th><th>Part</th>
        <th>Acc</th><th>Flu</th><th>Comp</th><th>Pron</th>
        <th class="text">Text</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script type="module">
const qs = new URLSearchParams(location.search);
let TOKEN = sessionStorage.getItem('ADMIN_TOKEN') || qs.get('token');
if (!TOKEN) {
  TOKEN = prompt('Enter ADMIN_TOKEN');
  if (!TOKEN) throw new Error('No token');
  sessionStorage.setItem('ADMIN_TOKEN', TOKEN);
}

const uidEl   = document.getElementById('uid');
const limitEl = document.getElementById('limit');
const csvEl   = document.getElementById('csv');
const tbody   = document.querySelector('#grid tbody');
const titleEl = document.getElementById('title');

uidEl.value = qs.get('uid') || '';

document.getElementById('load').addEventListener('click', load);

let chart;
function drawChart(labels, dailyPron, ma7) {
  if (chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Daily avg', data: dailyPron, tension: 0.2, fill: false },
        { label: '7-day avg', data: ma7, borderDash: [6, 6], pointRadius: 0, tension: 0.2 }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { min: 0, max: 100, title: { display: true, text: 'Pron' } }
      }
    }
  });
}

async function fetchRows(uid, limit) {
  const url = `/api/admin-recent?token=${encodeURIComponent(TOKEN)}&uid=${encodeURIComponent(uid)}&limit=${limit}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('admin-recent failed');
  return (await r.json()).rows || [];
}

async function fetchLabel(uid) {
  const url = `/api/admin-label-user?token=${encodeURIComponent(TOKEN)}&uid=${encodeURIComponent(uid)}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) return null;
  const { rows } = await r.json();
  return rows?.[0]?.label || null;
}

// group by day and compute daily averages
function dailySeries(rows) {
  const byDay = new Map(); // YYYY-MM-DD -> {sum,count}
  for (const r of rows) {
    const p = r?.summary?.pron;
    if (typeof p !== 'number') continue;
    const d = new Date(r.ts);
    const day = d.toISOString().slice(0, 10);
    const obj = byDay.get(day) || { sum: 0, count: 0 };
    obj.sum += p; obj.count += 1;
    byDay.set(day, obj);
  }
  const labels = Array.from(byDay.keys()).sort();
  const daily = labels.map(k => byDay.get(k).sum / byDay.get(k).count);
  return { labels, daily };
}

function movingAvg(values, window = 7) {
  const out = [];
  for (let i = 0; i < values.length; i++) {
    const a = Math.max(0, i - (window - 1));
    const slice = values.slice(a, i + 1);
    out.push(slice.reduce((s, v) => s + v, 0) / slice.length);
  }
  return out;
}

function esc(s){return (s||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}

async function load() {
  const uid = uidEl.value.trim();
  if (!uid) return alert('Enter a UID');
  const limit = Number(limitEl.value) || 500;

  csvEl.href = `/api/admin-resend?token=${encodeURIComponent(TOKEN)}&format=csv&uid=${encodeURIComponent(uid)}&limit=${limit}`;

  const [rows, label] = await Promise.all([fetchRows(uid, limit), fetchLabel(uid)]);
  titleEl.textContent = label ? `User Progress – ${label} (${uid})` : `User Progress – ${uid}`;

  // table
