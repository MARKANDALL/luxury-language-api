<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Attempts (admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 14px; color:#222; }
    h1 { font-size: 1.4rem; margin: 0 0 12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { margin: 4px 0; }
    input[type="number"], input[type="date"], input[type="text"], button, select {
      padding:6px 10px; font-size:14px; border:1px solid #c8c8c8; border-radius:6px;
    }
    button { background:#0a66ff; color:#fff; border:0; cursor:pointer; }
    button.secondary { background:#f3f3f3; color:#222; }
    button:disabled { background:#bbb; cursor:not-allowed; }
    label { font-size:13px; color:#555; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #ddd; border-radius:999px; font-size:13px; }
    .right { margin-left:auto; }
    .muted { color:#666; font-size:12px; }
    .ok { color:#0a7c3b; }
    .bad { color:#b00020; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:13px; white-space:nowrap; }
    th { background:#f5f7fa; text-align:left; }
    td.text { white-space:normal; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#eef3ff; color:#1a4bff; font-weight:600; font-size:12px; }
    .note { font-size:12px; color:#666; }
  </style>

  <script>
    // --- Token handling (Option C) -----------------------------------------
    // 1) Read ?token= once and keep for this tab
    (function ensureAdminToken(){
      const q = new URLSearchParams(location.search);
      const t = q.get('token');
      if (t) sessionStorage.setItem('lux_admin_token', t);
      // optional convenience: if token missing, allow ?t= alias
      const t2 = q.get('t');
      if (!t && t2) sessionStorage.setItem('lux_admin_token', t2);
    })();

    function authHeaders() {
      const tok = sessionStorage.getItem('lux_admin_token') || '';
      return tok ? { 'x-admin-token': tok } : {};
    }

    function setToken(tok) {
      if (tok && tok.trim()) sessionStorage.setItem('lux_admin_token', tok.trim());
      else sessionStorage.removeItem('lux_admin_token');
      updateTokenBadge();
    }

    function updateTokenBadge(){
      const badge = document.getElementById('tokenBadge');
      const tok = sessionStorage.getItem('lux_admin_token');
      badge.textContent = tok ? 'Token set ✓' : 'No token';
      badge.className = 'pill ' + (tok ? 'ok' : 'bad');
    }

    // --- Helpers -----------------------------------------------------------
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtLocal(iso){
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return iso || ''; }
    }
    function getPassages() {
      return Array.from(document.querySelectorAll('[data-pass]'))
        .filter(x => x.checked).map(x => x.value);
    }
    function setPassages(list) {
      const set = new Set(list);
      document.querySelectorAll('[data-pass]').forEach(x => x.checked = set.has(x.value));
    }

    function readUI(){
      return {
        uid: (document.getElementById('uidFilter').value || '').trim(),
        from: document.getElementById('from').value,
        to:   document.getElementById('to').value,
        limit: parseInt(document.getElementById('limit').value,10) || 200,
        passages: getPassages()
      };
    }

    function writeUI(q){
      if (q.uid != null)   document.getElementById('uidFilter').value = q.uid;
      if (q.from != null)  document.getElementById('from').value = q.from;
      if (q.to != null)    document.getElementById('to').value   = q.to;
      if (q.limit != null) document.getElementById('limit').value = q.limit;
      if (q.passages) setPassages(q.passages);
    }

    function paramsFromUI(){
      const q = readUI();
      const p = new URLSearchParams();
      if (q.uid) p.set('uid', q.uid);
      if (q.from) p.set('from', q.from);
      if (q.to)   p.set('to', q.to);
      if (q.limit) p.set('limit', String(q.limit));
      if (q.passages && q.passages.length) p.set('passages', q.passages.join(','));
      return p;
    }

    function uiFromURL(){
      const qs = new URLSearchParams(location.search);
      const obj = {};
      if (qs.get('uid')) obj.uid = qs.get('uid');
      if (qs.get('from')) obj.from = qs.get('from');
      if (qs.get('to'))   obj.to   = qs.get('to');
      if (qs.get('limit')) obj.limit = parseInt(qs.get('limit'),10) || 200;
      if (qs.get('passages')) obj.passages = qs.get('passages').split(',').filter(Boolean);
      return obj;
    }

    // --- Data load ---------------------------------------------------------
    async function loadAttempts() {
      const tbody = document.getElementById('rows');
      const countEl = document.getElementById('count');
      tbody.innerHTML = '';
      countEl.textContent = '…';

      const p = paramsFromUI();
      const res = await fetch(`/api/admin-recent?${p.toString()}`, {
        headers: { ...authHeaders() }
      });
      if (!res.ok) {
        countEl.textContent = 'error';
        const txt = await res.text().catch(()=> '');
        alert(`Failed to load (HTTP ${res.status}).\n${txt}`);
        return;
      }
      const json = await res.json();
      const rows = Array.isArray(json?.rows) ? json.rows : [];

      for (const r of rows) {
        const s = r.summary || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtLocal(r.ts)}</td>
          <td title="${r.uid}">${r.label || r.uid || ''}</td>
          <td>${r.passage_key || ''}</td>
          <td>${r.part_index ?? ''}</td>
          <td>${s.acc ?? ''}</td>
          <td>${s.flu ?? ''}</td>
          <td>${s.comp ?? ''}</td>
          <td>${s.pron ?? ''}</td>
          <td class="text">${(r.text || '').replace(/\s+/g,' ').slice(0,400)}</td>
        `;
        tbody.appendChild(tr);
      }
      countEl.textContent = String(rows.length);
    }

    // --- CSV download ------------------------------------------------------
    async function downloadCSV() {
      const p = paramsFromUI();
      p.set('format','csv');
      const res = await fetch(`/api/admin-recent?${p.toString()}`, {
        headers: { ...authHeaders() }
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        alert(`CSV download failed (HTTP ${res.status}).\n${txt}`);
        return;
      }
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'lux_attempts.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // --- Copy link (no token by default) ----------------------------------
    function copyLink(includeToken=false) {
      const p = paramsFromUI();
      if (includeToken) {
        const tok = sessionStorage.getItem('lux_admin_token');
        if (tok) p.set('token', tok);
      }
      const url = `${location.origin}${location.pathname}?${p.toString()}`;
      navigator.clipboard.writeText(url).then(()=> {
        alert('Link copied to clipboard.');
      });
    }

    // --- Init --------------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
      // Defaults: last 2 days, all passages, limit 200
      const today = todayISO();
      const yday  = addDays(today, -1).toISOString().slice(0,10);
      writeUI({ from: yday, to: today, limit: 200, passages: ['grandfather','rainbow','sentences','wordList'] });
      // Apply URL state (uid, dates, etc.)
      writeUI(uiFromURL());
      // Prefill UID if present in URL
      const qs = new URLSearchParams(location.search);
      if (qs.get('uid')) document.getElementById('uidFilter').value = qs.get('uid');

      // Wire events
      document.getElementById('reloadBtn').onclick = loadAttempts;
      document.getElementById('csvBtn').onclick = downloadCSV;
      document.getElementById('copyBtn').onclick = () => copyLink(false);
      document.getElementById('copyWithTokenBtn').onclick = () => copyLink(true);
      document.getElementById('saveTokBtn').onclick = () => {
        const v = document.getElementById('tokInput').value;
        setToken(v);
        loadAttempts();
      };

      updateTokenBadge();
      loadAttempts();
    });
  </script>
</head>
<body>
  <nav style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
    <a href="/admin/user.html">Attempts</a>
    <a href="/admin/index.html">User Progress</a>
    <span style="margin-left:auto;color:#666;font-size:12px">Token lives in this tab</span>
  </nav>

  <h1>Attempts (admin)</h1>


  <div class="toolbar">
    <label>Limit
      <input id="limit" type="number" value="200" min="1" max="2000" style="width:90px" />
    </label>
    <button id="reloadBtn">Reload</button>
    <button id="csvBtn" class="secondary">Download CSV</button>
    <button id="copyBtn" class="secondary">Copy link</button>
    <button id="copyWithTokenBtn" class="secondary">Copy link + token</button>

    <span class="right note">Token is stored in this tab’s session only.</span>
  </div>

  <div class="row" style="margin-top:8px">
    <label>From <input id="from" type="date" /></label>
    <label>To <input id="to" type="date" /></label>

    <span class="chip">
      <input type="checkbox" data-pass value="grandfather" checked /> grandfather
    </span>
    <span class="chip">
      <input type="checkbox" data-pass value="rainbow" checked /> rainbow
    </span>
    <span class="chip">
      <input type="checkbox" data-pass value="sentences" checked /> sentences
    </span>
    <span class="chip">
      <input type="checkbox" data-pass value="wordList" checked /> wordList
    </span>

    <span class="right chip">
      <span>UID filter</span>
      <input id="uidFilter" type="text" placeholder="paste UID…" style="width:320px" />
    </span>
  </div>

  <div class="row" style="margin-top:6px">
    <span id="tokenBadge" class="pill">Token set?</span>
    <input id="tokInput" type="text" placeholder="paste admin token…" style="width:260px" />
    <button id="saveTokBtn" class="secondary">Set token</button>
    <span class="note">Rows: <strong id="count">0</strong></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="min-width:160px">Time (local)</th>
        <th style="min-width:220px">User</th>
        <th>Passage</th>
        <th>Part</th>
        <th>Acc</th>
        <th>Flu</th>
        <th>Comp</th>
        <th>Pron</th>
        <th style="min-width:420px">Text</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</body>
</html>
