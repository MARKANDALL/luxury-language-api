<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Overview (admin)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px}
  h1{margin:0 0 12px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 12px}
  input,select,button,a.btn{height:36px;padding:8px;border:1px solid #ccc;border-radius:8px;background:#fff}
  a.btn{text-decoration:none;display:inline-flex;align-items:center}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #e7e7e7;padding:8px;vertical-align:top}
  th{background:#f7f9fc;position:sticky;top:0}
  .muted{color:#666}
</style>
</head>
<body>
<h1>Overview (admin)</h1>

<div class="bar">
  <label>Limit <input id="limit" type="number" value="2000" min="1" max="20000" style="width:100px"></label>
  <label>From <input id="from" type="date"></label>
  <label>To <input id="to" type="date"></label>
  <button id="loadBtn">Load</button>
  <a id="csvAll" class="btn" target="_blank">Download CSV (all)</a>
  <span class="muted">Token stored in this tab only.</span>
</div>

<table id="grid">
  <thead>
    <tr>
      <th style="width:220px">User (label)</th>
      <th>UID</th>
      <th>Attempts</th>
      <th>Avg Pron</th>
      <th>Last Pron</th>
      <th>Last time (local)</th>
      <th>Open</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
(async function(){
  const qs = new URLSearchParams(location.search);
  let TOKEN = sessionStorage.getItem('ADMIN_TOKEN') || qs.get('token');
  if (!TOKEN) {
    TOKEN = prompt('Enter ADMIN_TOKEN');
    if (TOKEN) sessionStorage.setItem('ADMIN_TOKEN', TOKEN);
  }

  const limitEl = document.getElementById('limit');
  const fromEl = document.getElementById('from');
  const toEl = document.getElementById('to');
  const loadBtn = document.getElementById('loadBtn');
  const csvAll = document.getElementById('csvAll');
  const tbody = document.querySelector('#grid tbody');

  // default dates (past 14 days)
  const pad = n=>String(n).padStart(2,'0');
  const toStr = d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const today = new Date(); const fromD = new Date(); fromD.setDate(fromD.getDate()-14);
  fromEl.value = qs.get('from') || toStr(fromD);
  toEl.value = qs.get('to') || toStr(today);

  function updateCsvLink(){
    const u = `/api/admin-resend?format=csv&limit=${encodeURIComponent(limitEl.value)}&token=${encodeURIComponent(TOKEN)}`
            + `&from=${encodeURIComponent(fromEl.value)}&to=${encodeURIComponent(toEl.value)}`;
    csvAll.href = u;
  }

  function group(rows){
    const map = new Map();
    for (const r of rows){
      const uid = r.uid;
      const s = r.summary||{};
      const pron = Number(s.pron);
      let g = map.get(uid);
      if (!g) g = {uid, label:r.label||'', rows:[], lastTs:r.ts};
      g.rows.push(r);
      if (!g.label && r.label) g.label = r.label;
      if (!g.lastTs || new Date(r.ts) > new Date(g.lastTs)) g.lastTs = r.ts;
      map.set(uid, g);
    }
    return [...map.values()];
  }

  function render(groups){
    tbody.innerHTML = '';
    groups.sort((a,b)=> new Date(b.lastTs) - new Date(a.lastTs));
    for (const g of groups){
      const vals = g.rows.map(x=>Number(x?.summary?.pron)).filter(Number.isFinite);
      const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : '–';
      const last = (()=>{
        const latest = g.rows.slice().sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];
        return latest?.summary?.pron ?? '';
      })();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${g.label || '—'}</td>
        <td>${g.uid}</td>
        <td>${g.rows.length}</td>
        <td>${avg}</td>
        <td>${last}</td>
        <td>${new Date(g.lastTs).toLocaleString()}</td>
        <td><a href="/admin/user.html?uid=${encodeURIComponent(g.uid)}&from=${encodeURIComponent(fromEl.value)}&to=${encodeURIComponent(toEl.value)}" target="_blank">Open</a></td>`;
      tbody.appendChild(tr);
    }
  }

  async function load(){
    const limit = Number(limitEl.value||2000);
    const url = `/api/admin-recent?token=${encodeURIComponent(TOKEN)}&limit=${limit}`
              + `&from=${encodeURIComponent(fromEl.value)}&to=${encodeURIComponent(toEl.value)}`;
    loadBtn.disabled = true;
    try{
      const r = await fetch(url, {cache:'no-store'});
      const {rows=[]} = await r.json();
      render(group(rows));
      updateCsvLink();
    } finally {
      loadBtn.disabled = false;
    }
  }

  loadBtn.addEventListener('click', load);
  [limitEl, fromEl, toEl].forEach(el=>el.addEventListener('change', updateCsvLink));
  updateCsvLink();
  load();
})();
</script>
</body>
</html>
